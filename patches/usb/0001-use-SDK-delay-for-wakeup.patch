From 17f6f616c91abe1929df346866b1c3405f09594e Mon Sep 17 00:00:00 2001
From: Benedek Kupper <kupper.benedek@gmail.com>
Date: Tue, 22 Jul 2025 15:52:37 +0200
Subject: [PATCH] use SDK delay for wakeup

---
 device/usb_device_ehci.c | 6 +-----
 device/usb_device_khci.c | 6 +-----
 2 files changed, 2 insertions(+), 10 deletions(-)

diff --git a/device/usb_device_ehci.c b/device/usb_device_ehci.c
index 1780f87..e6462fe 100644
--- a/device/usb_device_ehci.c
+++ b/device/usb_device_ehci.c
@@ -2073,11 +2073,7 @@ usb_status_t USB_DeviceEhciControl(usb_device_controller_handle ehciHandle, usb_
 #endif
             ehciState->registerBase->PORTSC1 &= ~USBHS_PORTSC1_PHCD_MASK;
             ehciState->registerBase->PORTSC1 |= USBHS_PORTSC1_FPR_MASK;
-            startTick = deviceHandle->hwTick;
-            while ((deviceHandle->hwTick - startTick) < 10U)
-            {
-                __NOP();
-            }
+            SDK_DelayAtLeastUs(3000U, SystemCoreClock);
             ehciState->registerBase->PORTSC1 &= ~USBHS_PORTSC1_FPR_MASK;
             error = kStatus_USB_Success;
             break;
diff --git a/device/usb_device_khci.c b/device/usb_device_khci.c
index c62addc..f0e1fce 100644
--- a/device/usb_device_khci.c
+++ b/device/usb_device_khci.c
@@ -1627,11 +1627,7 @@ usb_status_t USB_DeviceKhciControl(usb_device_controller_handle khciHandle, usb_
 #if defined(USB_DEVICE_CONFIG_REMOTE_WAKEUP) && (USB_DEVICE_CONFIG_REMOTE_WAKEUP > 0U)
         case kUSB_DeviceControlResume:
             khciState->registerBase->CTL |= USB_CTL_RESUME_MASK;
-            startTick = deviceHandle->hwTick;
-            while ((deviceHandle->hwTick - startTick) < 10U)
-            {
-                __NOP();
-            }
+            SDK_DelayAtLeastUs(3000U, SystemCoreClock);
             khciState->registerBase->CTL &= (uint8_t)(~USB_CTL_RESUME_MASK);
             status = kStatus_USB_Success;
             break;
-- 
2.43.0

